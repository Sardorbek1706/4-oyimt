generator client {
  provider = "prisma-client-js"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
}

enum Roles {
  user
  admin
  superadmin
}

enum Status {
  active
  inactive
}

enum SubsStatus {
  active
  expired
  canceled
  pending_payment
}

enum PaymentMethod {
  card
  paypal
  bank_transfer
  crypto
}

enum PaymentStatus {
  pending
  completed
  failed
  refunded
}

enum SubscriptionType {
  free
  premium
}

enum Quality {
  RES_240p  @map("240p")
  RES_360p  @map("360p")
  RES_480p  @map("480p")
  RES_720p  @map("720p")
  RES_1080p @map("1080p")
  RES_4K    @map("4K")
}

enum Languages {
  uz
  en
  ru
}

model Users {
  id            String   @id @default(uuid())
  username      String   @unique
  email         String   @unique
  password_hash String
  role          Roles    @default(user)
  avatar_url    String
  created_at    DateTime @default(now()) @db.Timestamptz(6)
  updated_at    DateTime @updatedAt @db.Timestamptz(6)
  status        Status   @default(active)

  profiles           Profiles[]
  user_subscriptions User_subscriptions[]
  movies             Movies[]
  favorites          Favorites[]
  reviews            Reviews[]
  watch_history      Watch_history[]

  @@map("users")
}

model Profiles {
  id         String   @id @default(uuid())
  user_id    String
  full_name  String
  phone      String   @unique
  country    String
  created_at DateTime @default(now()) @db.Timestamptz(6)
  updated_at DateTime @updatedAt @db.Timestamptz(6)
  status     Status   @default(active)

  user Users @relation(fields: [user_id], references: [id])

  @@map("profiles")
}

model Subscription_plans {
  id            String   @id @default(uuid())
  name          String   @unique
  price         Decimal  @db.Decimal(10, 2)
  duration_days Int
  features      Json
  is_active     Boolean  @default(true)
  status        Status   @default(active)
  created_at    DateTime @default(now()) @db.Timestamptz(6)
  updated_at    DateTime @updatedAt @db.Timestamptz(6)

  user_subscriptions User_subscriptions[]

  @@map("subscription_plans")
}

model User_subscriptions {
  id         String     @id @default(uuid())
  user_id    String
  plan_id    String
  start_date DateTime   @default(now()) @db.Timestamptz(6)
  end_date   DateTime
  status     SubsStatus @default(pending_payment)
  auto_renew Boolean    @default(false)
  created_at DateTime   @default(now()) @db.Timestamptz(6)
  updated_at DateTime   @updatedAt @db.Timestamptz(6)

  user     Users              @relation(fields: [user_id], references: [id])
  plan     Subscription_plans @relation(fields: [plan_id], references: [id])
  payments Payments[]

  @@map("user_subscriptions")
}

model Payments {
  id                      String        @id @default(uuid())
  user_subscription_id    String
  amount                  Decimal       @db.Decimal(10, 2)
  payment_method          PaymentMethod
  payment_details         Json
  status                  PaymentStatus
  external_transaction_id String
  created_at              DateTime      @default(now()) @db.Timestamptz(6)
  updated_at              DateTime      @updatedAt @db.Timestamptz(6)

  user_subscription User_subscriptions @relation(fields: [user_subscription_id], references: [id])

  @@map("payments")
}

model Categories {
  id          String @id @default(uuid())
  name        String
  slug        String @unique
  description String
  status      Status @default(active)

  movie_categories Movie_categories[]

  @@map("categories")
}

model Movies {
  id                String           @id @default(uuid())
  title             String
  slug              String           @unique
  description       String
  release_year      Int
  duration_minutes  Int
  poster_url        String
  rating            Decimal          @db.Decimal(3, 1)
  subscription_type SubscriptionType @default(free)
  view_count        Int              @default(0)
  created_by        String           @unique
  created_at        DateTime         @default(now()) @db.Timestamptz(6)
  updated_at        DateTime         @updatedAt @db.Timestamptz(6)
  status            Status           @default(active)

  movie_categories Movie_categories[]
  movie_files      Movie_files[]
  favorites        Favorites[]
  reviews          Reviews[]
  watch_history    Watch_history[]
  user             Users              @relation(fields: [created_by], references: [id])

  @@map("movies")
}

model Movie_categories {
  id          String @id @default(uuid())
  movie_id    String
  category_id String

  movies     Movies     @relation(fields: [movie_id], references: [id])
  categories Categories @relation(fields: [category_id], references: [id])

  @@map("movie_categories")
}

model Movie_files {
  id       String    @id @default(uuid())
  movie_id String
  file_url String
  quality  Quality
  language Languages @default(uz)
  status   Status    @default(active)

  movies Movies @relation(fields: [movie_id], references: [id])

  @@map("movie_files")
}

model Favorites {
  id         String   @id @default(uuid())
  user_id    String
  movie_id   String
  created_at DateTime @default(now()) @db.Timestamptz(6)
  updated_at DateTime @updatedAt @db.Timestamptz(6)

  users  Users  @relation(fields: [user_id], references: [id])
  movies Movies @relation(fields: [movie_id], references: [id])

  @@map("favorites")
}

model Reviews {
  id         String   @id @default(uuid())
  user_id    String
  movie_id   String
  rating     Int
  comment    String
  created_at DateTime @default(now()) @db.Timestamptz(6)
  updated_at DateTime @updatedAt @db.Timestamptz(6)

  users  Users  @relation(fields: [user_id], references: [id])
  movies Movies @relation(fields: [movie_id], references: [id])

  @@map("reviews")
}

model Watch_history {
  id                 String   @id @default(uuid())
  user_id            String
  movie_id           String
  watched_duration   Int
  watched_percentage Decimal  @db.Decimal(5, 2)
  last_watched       DateTime @default(now()) @db.Timestamptz(6)

  users  Users  @relation(fields: [user_id], references: [id])
  movies Movies @relation(fields: [movie_id], references: [id])

  @@map("watch_history")
}
